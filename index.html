<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éšæ¥­ç¸¾æŸ¥è©¢ç³»çµ± - iStore Taiwan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: white;
            padding: 50px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 42px;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header p {
            opacity: 0.95;
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 2px;
        }

        .filters-section {
            padding: 40px 35px;
            background: #f5f7fa;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f3460;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-group {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(15, 52, 96, 0.08);
            border: 1px solid #e8ecf1;
            transition: all 0.3s;
        }

        .filter-group:hover {
            box-shadow: 0 4px 20px rgba(15, 52, 96, 0.15);
            transform: translateY(-2px);
        }

        .filter-group label {
            display: block;
            font-weight: 700;
            color: #16213e;
            margin-bottom: 12px;
            font-size: 13px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 13px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
            background: #fafbfc;
            color: #2c3e50;
            font-weight: 500;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #0ea5e9;
            background: white;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        .date-range-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .compare-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #06b6d4;
            box-shadow: 0 2px 15px rgba(6, 182, 212, 0.1);
        }

        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }

        .compare-period {
            background: #f0fdfa;
            padding: 22px;
            border-radius: 10px;
            border: 2px solid #5eead4;
        }

        .compare-period h4 {
            font-size: 14px;
            font-weight: 700;
            color: #0f766e;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .compare-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .compare-inputs input {
            padding: 12px 14px;
            border: 2px solid #99f6e4;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #2c3e50;
            font-weight: 500;
        }

        .compare-inputs input:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #0f3460;
            border: 2px solid #0f3460;
        }

        .btn-secondary:hover {
            background: #0f3460;
            color: white;
        }

        .results-section {
            padding: 40px 35px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 5px solid;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stat-card.primary {
            border-left-color: #3b82f6;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.info {
            border-left-color: #06b6d4;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .stat-detail {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .table-header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: white;
            padding: 25px 30px;
        }

        .table-header h3 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
        }

        thead th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        tbody td {
            padding: 18px 20px;
            font-size: 15px;
            color: #334155;
            font-weight: 500;
        }

        .number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
            font-size: 16px;
        }

        .json-input-section {
            background: #f0f9ff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #bae6fd;
        }

        .json-input-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .json-input-section input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #7dd3fc;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #0c4a6e;
            font-family: 'Courier New', monospace;
        }

        .json-input-section input:focus {
            outline: none;
            border-color: #0284c7;
            box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1);
        }

        .json-status {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .json-status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .json-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .json-status.info {
            background: #dbeafe;
            color: #1e3a8a;
            border: 1px solid #93c5fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š é€²éšæ¥­ç¸¾æŸ¥è©¢ç³»çµ±</h1>
            <p>iStore Taiwan | å…¨åº—æ¥­ç¸¾åˆ†æå¹³å°</p>
        </div>

        <div class="filters-section">
            <!-- JSON è³‡æ–™ä¾†æºè¨­å®š -->
            <div class="json-input-section">
                <h3>ğŸ“‚ è³‡æ–™ä¾†æºè¨­å®š</h3>
                <input 
                    type="text" 
                    id="jsonUrl" 
                    placeholder="è¼¸å…¥ JSON æª”æ¡ˆç¶²å€æˆ– GitHub Raw URL..."
                    value=""
                >
                <div id="jsonStatus" class="json-status" style="display: none;"></div>
            </div>

            <div class="section-title">ğŸ” ç¯©é¸æ¢ä»¶</div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label>å¹´ä»½</label>
                    <select id="yearFilter">
                        <option value="">å…¨éƒ¨å¹´ä»½</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>æœˆä»½</label>
                    <select id="monthFilter">
                        <option value="">å…¨éƒ¨æœˆä»½</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>åº—åˆ¥</label>
                    <select id="storeFilter">
                        <option value="">å…¨éƒ¨åº—åˆ¥</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>æ—¥æœŸç¯„åœ</label>
                    <div class="date-range-group">
                        <input type="date" id="startDate" placeholder="é–‹å§‹æ—¥æœŸ">
                        <input type="date" id="endDate" placeholder="çµæŸæ—¥æœŸ">
                    </div>
                </div>
            </div>

            <!-- å€é–“æ¯”è¼ƒåŠŸèƒ½ -->
            <div class="compare-section">
                <div class="section-title">ğŸ“ˆ å€é–“æ¯”è¼ƒåˆ†æ</div>
                
                <!-- åº—åˆ¥é¸æ“‡ -->
                <div style="margin-bottom: 20px;">
                    <div class="filter-group" style="max-width: 400px;">
                        <label>æ¯”è¼ƒåº—åˆ¥ï¼ˆå¯é¸ï¼‰</label>
                        <select id="compareStore">
                            <option value="">å…¨éƒ¨åº—åˆ¥</option>
                        </select>
                    </div>
                </div>
                
                <div class="compare-grid">
                    <div class="compare-period">
                        <h4>åŸºæº–æœŸé–“</h4>
                        <div class="compare-inputs">
                            <input type="date" id="baseStart" placeholder="é–‹å§‹æ—¥æœŸ">
                            <input type="date" id="baseEnd" placeholder="çµæŸæ—¥æœŸ">
                        </div>
                    </div>
                    <div class="compare-period">
                        <h4>æ¯”è¼ƒæœŸé–“</h4>
                        <div class="compare-inputs">
                            <input type="date" id="compareStart" placeholder="é–‹å§‹æ—¥æœŸ">
                            <input type="date" id="compareEnd" placeholder="çµæŸæ—¥æœŸ">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                <button class="btn btn-primary" onclick="compareIntervals()">åŸ·è¡Œæ¯”è¼ƒ</button>
            </div>
        </div>

        <div class="results-section">
            <div id="statsContainer"></div>
            <div id="tableContainer"></div>
        </div>
    </div>

    <script>
        // åº—åˆ¥å°ç…§è¡¨ - æŒ‰ç…§é †åºç·¨è™Ÿæ’åˆ—
        const storeMapping = {
            'NK[i]store': { name: 'å—è¥¿', order: 45 },
            'TM[i]store': { name: 'å¤©æ¯', order: 47 },
            'MS[i]store': { name: 'ç«™å‰', order: 48 },
            'SYA11[i]store': { name: 'A11', order: 51 },
            'A4[i]store': { name: 'A4', order: 57 },
            'DZ[i]store': { name: 'å¤§ç›´', order: 59 },
            'QP[i]store': { name: 'é’åŸ”', order: 61 },
            'TY[i]store': { name: 'æ¡ƒç«™', order: 65 },
            'TC[i]store': { name: 'ä¸­æ¸¯', order: 75 },
            'ä¸­å‹[i]store': { name: 'ä¸­å‹', order: 76 },
            'MOPå°ä¸­[i]store': { name: 'å°ä¸­ä¸‰äº•', order: 77 },
            'è€æ–¯[i]store': { name: 'è€æ–¯', order: 81 },
            'å‚æ¥Š[i]store': { name: 'å‚æ¥Š', order: 84 },
            'è¥¿é–€[i]store': { name: 'è¥¿é–€', order: 86 },
            'ä¸­å±±[i]store': { name: 'ä¸­å±±', order: 88 },
            'MTN[i]store': { name: 'å°å—ä¸‰äº•', order: 89 },
            'XBM[i]store': { name: 'å°åŒ—é–€', order: 97 },
            'ZU[i]store': { name: 'å·¦ç‡Ÿ', order: 115 },
            'ä¸‰å¤š[i]store': { name: 'ä¸‰å¤š', order: 116 },
            'SP[i]store': { name: 'SKM Park', order: 117 }
        };

        let allData = [];
        let filteredData = [];

        // è¼‰å…¥JSONè³‡æ–™
        async function loadJSON(url) {
            const statusDiv = document.getElementById('jsonStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'json-status info';
            statusDiv.textContent = 'â³ æ­£åœ¨è¼‰å…¥è³‡æ–™...';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // è™•ç†è³‡æ–™ï¼šå°‡Excelä»£ç¢¼è½‰æ›ç‚ºé¡¯ç¤ºåç¨±
                allData = data.map(item => {
                    const storeInfo = Object.values(storeMapping).find(s => s.name === item.åº—åˆ¥);
                    return {
                        ...item,
                        åº—åˆ¥é †åº: storeInfo ? storeInfo.order : 999
                    };
                });

                filteredData = [...allData];
                
                statusDiv.className = 'json-status success';
                statusDiv.textContent = `âœ… æˆåŠŸè¼‰å…¥ ${allData.length.toLocaleString()} ç­†è³‡æ–™`;
                
                initializeFilters();
                applyFilters();
                
                // 3ç§’å¾Œéš±è—ç‹€æ…‹è¨Šæ¯
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                statusDiv.className = 'json-status error';
                statusDiv.textContent = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
                console.error('è¼‰å…¥JSONå¤±æ•—:', error);
            }
        }

        // JSON URL è¼¸å…¥æ¡†è®Šæ›´äº‹ä»¶
        document.getElementById('jsonUrl').addEventListener('change', function(e) {
            const url = e.target.value.trim();
            if (url) {
                loadJSON(url);
            }
        });

        // åˆå§‹åŒ–ç¯©é¸å™¨é¸é …
        function initializeFilters() {
            // å¹´ä»½
            const years = [...new Set(allData.map(d => d.å¹´ä»½))].sort((a, b) => b - a);
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="">å…¨éƒ¨å¹´ä»½</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}å¹´</option>`;
            });

            // æœˆä»½
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>';
            for (let i = 1; i <= 12; i++) {
                monthFilter.innerHTML += `<option value="${i}">${i}æœˆ</option>`;
            }

            // åº—åˆ¥ - æŒ‰ç…§é †åºç·¨è™Ÿæ’åˆ—
            const stores = [...new Set(allData.map(d => d.åº—åˆ¥))]
                .map(store => {
                    const storeInfo = Object.values(storeMapping).find(s => s.name === store);
                    return {
                        name: store,
                        order: storeInfo ? storeInfo.order : 999
                    };
                })
                .sort((a, b) => a.order - b.order);

            const storeFilter = document.getElementById('storeFilter');
            storeFilter.innerHTML = '<option value="">å…¨éƒ¨åº—åˆ¥</option>';
            stores.forEach(store => {
                storeFilter.innerHTML += `<option value="${store.name}">${store.name}</option>`;
            });

            // æ¯”è¼ƒåº—åˆ¥é¸å–®ï¼ˆèˆ‡åº—åˆ¥ç¯©é¸ç›¸åŒï¼‰
            const compareStoreFilter = document.getElementById('compareStore');
            compareStoreFilter.innerHTML = '<option value="">å…¨éƒ¨åº—åˆ¥</option>';
            stores.forEach(store => {
                compareStoreFilter.innerHTML += `<option value="${store.name}">${store.name}</option>`;
            });
        }

        // å¥—ç”¨ç¯©é¸
        function applyFilters() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const store = document.getElementById('storeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredData = allData.filter(item => {
                if (year && item.å¹´ä»½ != year) return false;
                if (month && item.æœˆä»½æ•¸å­— != month) return false;
                if (store && item.åº—åˆ¥ !== store) return false;
                if (startDate && item.å®Œæ•´æ—¥æœŸ < startDate) return false;
                if (endDate && item.å®Œæ•´æ—¥æœŸ > endDate) return false;
                return true;
            });

            displayResults();
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('storeFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('baseStart').value = '';
            document.getElementById('baseEnd').value = '';
            document.getElementById('compareStart').value = '';
            document.getElementById('compareEnd').value = '';
            document.getElementById('compareStore').value = '';
            
            filteredData = [...allData];
            displayResults();
        }

        // é¡¯ç¤ºçµæœ
        function displayResults() {
            if (filteredData.length === 0) {
                document.getElementById('statsContainer').innerHTML = '';
                document.getElementById('tableContainer').innerHTML = '<div class="no-data">ğŸ“­ ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
                return;
            }

            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalSales = filteredData.reduce((sum, item) => sum + item.æ¥­ç¸¾, 0);
            const uniqueStores = new Set(filteredData.map(d => d.åº—åˆ¥)).size;
            const avgSales = Math.round(totalSales / filteredData.length);
            const maxSale = Math.max(...filteredData.map(d => d.æ¥­ç¸¾));
            const maxSaleItem = filteredData.find(d => d.æ¥­ç¸¾ === maxSale);

            // é¡¯ç¤ºçµ±è¨ˆå¡ç‰‡
            document.getElementById('statsContainer').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-label">ç¸½æ¥­ç¸¾</div>
                        <div class="stat-value">NT$ ${totalSales.toLocaleString()}</div>
                        <div class="stat-detail">å…± ${filteredData.length.toLocaleString()} ç­†è³‡æ–™</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">å¹³å‡æ¥­ç¸¾</div>
                        <div class="stat-value">NT$ ${avgSales.toLocaleString()}</div>
                        <div class="stat-detail">æ¯ç­†å¹³å‡</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">æœ€é«˜å–®æ—¥</div>
                        <div class="stat-value">NT$ ${maxSale.toLocaleString()}</div>
                        <div class="stat-detail">${maxSaleItem.åº—åˆ¥} - ${maxSaleItem.æ—¥æœŸ}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">åº—åˆ¥æ•¸é‡</div>
                        <div class="stat-value">${uniqueStores}</div>
                        <div class="stat-detail">å€‹åº—åˆ¥</div>
                    </div>
                </div>
            `;

            // æŒ‰æ¥­ç¸¾æ’åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
            const sortedData = [...filteredData].sort((a, b) => b.æ¥­ç¸¾ - a.æ¥­ç¸¾);

            // é¡¯ç¤ºæ¯æ—¥æ¥­ç¸¾è¡¨æ ¼
            let tableHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3>æ¯æ—¥æ¥­ç¸¾æ˜ç´°</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>æ—¥æœŸ</th>
                                <th>åº—åˆ¥</th>
                                <th class="number">æ¥­ç¸¾</th>
                                <th class="number">å æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedData.forEach((item, index) => {
                const percentage = ((item.æ¥­ç¸¾ / totalSales) * 100).toFixed(2);
                
                tableHTML += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>${item.å®Œæ•´æ—¥æœŸ}</td>
                        <td><strong>${item.åº—åˆ¥}</strong></td>
                        <td class="number">NT$ ${item.æ¥­ç¸¾.toLocaleString()}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        // å€é–“æ¯”è¼ƒåŠŸèƒ½
        function compareIntervals() {
            const baseStart = document.getElementById('baseStart').value;
            const baseEnd = document.getElementById('baseEnd').value;
            const compareStart = document.getElementById('compareStart').value;
            const compareEnd = document.getElementById('compareEnd').value;
            const compareStore = document.getElementById('compareStore').value;

            if (!baseStart || !baseEnd || !compareStart || !compareEnd) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„æ¯”è¼ƒæœŸé–“');
                return;
            }

            // åŸºæº–æœŸé–“è³‡æ–™
            let baseData = allData.filter(item => 
                item.å®Œæ•´æ—¥æœŸ >= baseStart && item.å®Œæ•´æ—¥æœŸ <= baseEnd
            );

            // æ¯”è¼ƒæœŸé–“è³‡æ–™
            let compareData = allData.filter(item => 
                item.å®Œæ•´æ—¥æœŸ >= compareStart && item.å®Œæ•´æ—¥æœŸ <= compareEnd
            );

            // å¦‚æœé¸æ“‡äº†ç‰¹å®šåº—åˆ¥ï¼Œå‰‡é€²ä¸€æ­¥ç¯©é¸
            if (compareStore) {
                baseData = baseData.filter(item => item.åº—åˆ¥ === compareStore);
                compareData = compareData.filter(item => item.åº—åˆ¥ === compareStore);
            }

            if (baseData.length === 0 || compareData.length === 0) {
                alert('é¸æ“‡çš„æœŸé–“æ²’æœ‰è³‡æ–™');
                return;
            }

            // è¨ˆç®—çµ±è¨ˆ
            const baseTotalSales = baseData.reduce((sum, item) => sum + item.æ¥­ç¸¾, 0);
            const compareTotalSales = compareData.reduce((sum, item) => sum + item.æ¥­ç¸¾, 0);
            const growthRate = ((compareTotalSales - baseTotalSales) / baseTotalSales * 100).toFixed(2);

            // å¦‚æœé¸æ“‡äº†ç‰¹å®šåº—åˆ¥ï¼Œé¡¯ç¤ºè©²åº—åˆ¥çš„æ¯æ—¥æ˜ç´°
            if (compareStore) {
                displaySingleStoreComparison(baseData, compareData, baseStart, baseEnd, compareStart, compareEnd, compareStore, baseTotalSales, compareTotalSales, growthRate);
            } else {
                // é¡¯ç¤ºæ‰€æœ‰åº—åˆ¥çš„æ¯”è¼ƒ
                displayAllStoresComparison(baseData, compareData, baseStart, baseEnd, compareStart, compareEnd, baseTotalSales, compareTotalSales, growthRate);
            }
        }

        // é¡¯ç¤ºå–®ä¸€åº—åˆ¥çš„æ¯”è¼ƒï¼ˆæ¯æ—¥æ˜ç´°ï¼‰
        function displaySingleStoreComparison(baseData, compareData, baseStart, baseEnd, compareStart, compareEnd, storeName, baseTotalSales, compareTotalSales, growthRate) {
            const diff = compareTotalSales - baseTotalSales;
            const growthClass = parseFloat(growthRate) >= 0 ? 'positive' : 'negative';

            // æŒ‰æ—¥æœŸæ’åº
            const baseSorted = [...baseData].sort((a, b) => a.å®Œæ•´æ—¥æœŸ.localeCompare(b.å®Œæ•´æ—¥æœŸ));
            const compareSorted = [...compareData].sort((a, b) => a.å®Œæ•´æ—¥æœŸ.localeCompare(b.å®Œæ•´æ—¥æœŸ));

            let compareHTML = `
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-label">åº—åˆ¥</div>
                        <div class="stat-value">${storeName}</div>
                        <div class="stat-detail">å–®åº—åˆ¥æ¯”è¼ƒ</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">åŸºæº–æœŸé–“</div>
                        <div class="stat-value">NT$ ${baseTotalSales.toLocaleString()}</div>
                        <div class="stat-detail">${baseStart} ~ ${baseEnd} (${baseData.length}å¤©)</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">æ¯”è¼ƒæœŸé–“</div>
                        <div class="stat-value">NT$ ${compareTotalSales.toLocaleString()}</div>
                        <div class="stat-detail">${compareStart} ~ ${compareEnd} (${compareData.length}å¤©)</div>
                    </div>
                    <div class="stat-card ${parseFloat(growthRate) >= 0 ? 'success' : 'warning'}">
                        <div class="stat-label">æˆé•·ç‡</div>
                        <div class="stat-value ${growthClass}">${growthRate}%</div>
                        <div class="stat-detail ${growthClass}">å·®é¡: NT$ ${diff.toLocaleString()}</div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3>${storeName} - æ¯æ—¥æ¥­ç¸¾æ¯”è¼ƒ</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th colspan="2" style="text-align: center; background: #e0f2fe;">åŸºæº–æœŸé–“</th>
                                <th colspan="2" style="text-align: center; background: #dbeafe;">æ¯”è¼ƒæœŸé–“</th>
                            </tr>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th class="number">æ¥­ç¸¾</th>
                                <th>æ—¥æœŸ</th>
                                <th class="number">æ¥­ç¸¾</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const maxLength = Math.max(baseSorted.length, compareSorted.length);
            for (let i = 0; i < maxLength; i++) {
                const baseItem = baseSorted[i];
                const compareItem = compareSorted[i];
                
                compareHTML += `
                    <tr>
                        <td>${baseItem ? baseItem.å®Œæ•´æ—¥æœŸ : '-'}</td>
                        <td class="number">${baseItem ? 'NT$ ' + baseItem.æ¥­ç¸¾.toLocaleString() : '-'}</td>
                        <td>${compareItem ? compareItem.å®Œæ•´æ—¥æœŸ : '-'}</td>
                        <td class="number">${compareItem ? 'NT$ ' + compareItem.æ¥­ç¸¾.toLocaleString() : '-'}</td>
                    </tr>
                `;
            }

            compareHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = compareHTML;
            document.getElementById('tableContainer').innerHTML = '';
        }

        // é¡¯ç¤ºæ‰€æœ‰åº—åˆ¥çš„æ¯”è¼ƒ
        function displayAllStoresComparison(baseData, compareData, baseStart, baseEnd, compareStart, compareEnd, baseTotalSales, compareTotalSales, growthRate) {
            // æŒ‰åº—åˆ¥æ¯”è¼ƒ
            const baseStoreStats = {};
            const compareStoreStats = {};

            baseData.forEach(item => {
                if (!baseStoreStats[item.åº—åˆ¥]) baseStoreStats[item.åº—åˆ¥] = 0;
                baseStoreStats[item.åº—åˆ¥] += item.æ¥­ç¸¾;
            });

            compareData.forEach(item => {
                if (!compareStoreStats[item.åº—åˆ¥]) compareStoreStats[item.åº—åˆ¥] = 0;
                compareStoreStats[item.åº—åˆ¥] += item.æ¥­ç¸¾;
            });

            // å»ºç«‹æ¯”è¼ƒè¡¨æ ¼
            const allStores = [...new Set([...Object.keys(baseStoreStats), ...Object.keys(compareStoreStats)])];
            const comparisonData = allStores.map(store => {
                const baseValue = baseStoreStats[store] || 0;
                const compareValue = compareStoreStats[store] || 0;
                const growth = baseValue > 0 ? ((compareValue - baseValue) / baseValue * 100).toFixed(2) : 0;
                const storeInfo = Object.values(storeMapping).find(s => s.name === store);
                
                return {
                    store,
                    baseValue,
                    compareValue,
                    growth: parseFloat(growth),
                    order: storeInfo ? storeInfo.order : 999
                };
            }).sort((a, b) => b.growth - a.growth);

            // é¡¯ç¤ºæ¯”è¼ƒçµæœ
            let compareHTML = `
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-label">åŸºæº–æœŸé–“</div>
                        <div class="stat-value">NT$ ${baseTotalSales.toLocaleString()}</div>
                        <div class="stat-detail">${baseStart} ~ ${baseEnd}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">æ¯”è¼ƒæœŸé–“</div>
                        <div class="stat-value">NT$ ${compareTotalSales.toLocaleString()}</div>
                        <div class="stat-detail">${compareStart} ~ ${compareEnd}</div>
                    </div>
                    <div class="stat-card ${parseFloat(growthRate) >= 0 ? 'success' : 'warning'}">
                        <div class="stat-label">æˆé•·ç‡</div>
                        <div class="stat-value ${parseFloat(growthRate) >= 0 ? 'positive' : 'negative'}">${growthRate}%</div>
                        <div class="stat-detail">ç¸½æ¥­ç¸¾è®ŠåŒ–</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">åº—åˆ¥æ•¸</div>
                        <div class="stat-value">${allStores.length}</div>
                        <div class="stat-detail">å€‹åº—åˆ¥</div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3>åº—åˆ¥æˆé•·ç‡æ¯”è¼ƒ</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>åº—åˆ¥</th>
                                <th class="number">åŸºæº–æœŸé–“</th>
                                <th class="number">æ¯”è¼ƒæœŸé–“</th>
                                <th class="number">æˆé•·é‡‘é¡</th>
                                <th class="number">æˆé•·ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            comparisonData.forEach(item => {
                const diff = item.compareValue - item.baseValue;
                const growthClass = item.growth >= 0 ? 'positive' : 'negative';
                
                compareHTML += `
                    <tr>
                        <td><strong>${item.store}</strong></td>
                        <td class="number">NT$ ${item.baseValue.toLocaleString()}</td>
                        <td class="number">NT$ ${item.compareValue.toLocaleString()}</td>
                        <td class="number ${growthClass}">NT$ ${diff.toLocaleString()}</td>
                        <td class="number ${growthClass}">${item.growth}%</td>
                    </tr>
                `;
            });

            compareHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = compareHTML;
            document.getElementById('tableContainer').innerHTML = '';
        }

        // åˆå§‹åŒ–æç¤º
        window.onload = function() {
            const statusDiv = document.getElementById('jsonStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'json-status info';
            statusDiv.textContent = 'ğŸ’¡ è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ JSON æª”æ¡ˆç¶²å€ä»¥è¼‰å…¥æ¥­ç¸¾è³‡æ–™';
        };
    </script>
</body>
</html>
